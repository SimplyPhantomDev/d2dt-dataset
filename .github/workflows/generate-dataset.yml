name: Generate dataset

on:
    workflow_dispatch:
    schedule:
        - cron: "0 3 * * 1"

permissions:
    contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      STRATZ_API_TOKEN: ${{ secrets.STRATZ_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps
        run: npm ci || npm install

      - name: Check STRATZ token is present (does not print it)
        run: node -e "console.log('token present:', !!process.env.STRATZ_API_TOKEN, 'len:', (process.env.STRATZ_API_TOKEN||'').length)"

      - name: Generate dataset
        run: |
          cd generator
          node generateMatchupData.js
                
      - name: Commit and push updated latest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add synergyMatrix.json manifest.json
          git commit -m "Update dataset" || echo "No changes to commit"
          git push
