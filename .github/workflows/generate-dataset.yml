name: Generate dataset

on:
    workflow_dispatch:
    schedule:
        - cron: "0 3 * * 1"

permissions:
    contents: write

jobs:
  build:
    runs-on: self-hosted
    env:
      STRATZ_API_TOKEN: ${{ secrets.STRATZ_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps
        shell: powershell
        run: |
          npm ci
          if ($LASTEXITCODE -ne 0) { npm install }

      - name: Check STRATZ token is present (does not print it)
        run: node -e "console.log('token present:', !!process.env.STRATZ_API_TOKEN, 'len:', (process.env.STRATZ_API_TOKEN||'').length)"

      - name: Generate heroes.json
        run: |
          cd generator
          node fetchHeroes.js
      - name: Generate dataset
        run: |
          cd generator
          node generateMatchupData.js
                
      - name: Commit and push updated dataset
        shell: powershell
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add synergyMatrix.json manifest.json heroes.json
          git diff --cached --quiet
          if ($LASTEXITCODE -ne 0) {
            git commit -m "Update dataset"
            git push
          } else {
            Write-Host "No changes to commit"
          }
